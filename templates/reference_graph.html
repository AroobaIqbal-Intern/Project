{% extends 'base.html' %}
{% load static %}

{% block title %}Reference Graph - Academic Reference Graph{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/vis-network/dist/dist/vis-network.min.css" rel="stylesheet">
<style>
.graph-container {
    height: 80vh;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f9fa;
    position: relative;
}

.graph-controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 100;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
}

.graph-controls button {
    margin: 2px;
    padding: 5px 10px;
    font-size: 12px;
}

.paper-info {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
    background: rgba(255,255,255,0.95);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    max-width: 300px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.paper-info h6 {
    margin-bottom: 10px;
    color: #007bff;
}

.paper-info p {
    margin-bottom: 5px;
    font-size: 14px;
}

.paper-info .btn {
    margin-top: 10px;
    width: 100%;
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    font-size: 18px;
    color: #666;
}

.loading i {
    margin-right: 10px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.graph-stats {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-3">
                <i class="fas fa-project-diagram"></i> Reference Graph Visualization
            </h1>
            <p class="text-muted">
                Interactive visualization of academic paper references and citations. Click on nodes to explore papers and their connections.
            </p>
        </div>
    </div>

    <!-- Graph Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="graph-stats">
                <h5 class="mb-3">Graph Statistics</h5>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalNodes">-</div>
                        <div class="stat-label">Papers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalEdges">-</div>
                        <div class="stat-label">References</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="maxDepth">-</div>
                        <div class="stat-label">Max Depth</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgReferences">-</div>
                        <div class="stat-label">Avg References</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graph Visualization -->
    <div class="row">
        <div class="col-12">
            <div class="graph-container">
                <div id="graphLoading" class="loading">
                    <i class="fas fa-spinner"></i> Loading reference graph...
                </div>
                <div id="graphNetwork" style="display: none;"></div>
                
                <!-- Graph Controls -->
                <div class="graph-controls">
                    <h6 class="mb-2">Controls</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="fitGraph()">
                        <i class="fas fa-expand"></i> Fit
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="stabilizeGraph()">
                        <i class="fas fa-cog"></i> Stabilize
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="resetGraph()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <hr class="my-2">
                    <button class="btn btn-sm btn-outline-success" onclick="exportGraph()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                
                <!-- Paper Info Panel -->
                <div class="paper-info" id="paperInfo" style="display: none;">
                    <h6 id="paperTitle">Paper Title</h6>
                    <p id="paperAuthor">Author</p>
                    <p id="paperYear">Year</p>
                    <p id="paperReferences">References: 0</p>
                    <p id="paperCitations">Citations: 0</p>
                    <button class="btn btn-primary btn-sm" id="viewPaperBtn">
                        <i class="fas fa-eye"></i> View Paper
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Graph Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Graph Legend</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-primary rounded-circle me-2" style="width: 20px; height: 20px;"></div>
                                <span>Papers</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success rounded-circle me-2" style="width: 20px; height: 20px;"></div>
                                <span>Highly Cited</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-warning rounded-circle me-2" style="width: 20px; height: 20px;"></div>
                                <span>Many References</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-info rounded-circle me-2" style="width: 20px; height: 20px;"></div>
                                <span>Connections</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/vis-network/dist/dist/vis-network.min.js"></script>
<script>
// Fallback for vis.js if CDN fails
if (typeof vis === 'undefined') {
    console.log('Loading vis.js from alternative CDN...');
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js';
    script.onload = function() {
        console.log('vis.js loaded from alternative CDN');
        if (typeof loadGraphData === 'function') {
            loadGraphData();
        }
    };
    script.onerror = function() {
        console.error('Failed to load vis.js from alternative CDN');
        document.getElementById('graphLoading').innerHTML = 
            '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: Could not load vis.js library</div>';
    };
    document.head.appendChild(script);
}
</script>
<script>
let network = null;
let nodes = null;
let edges = null;
let selectedPaperId = null;

// Initialize graph
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking vis.js availability...');
    if (typeof vis !== 'undefined') {
        console.log('vis.js is loaded');
        loadGraphData();
    } else {
        console.error('vis.js is not loaded!');
        document.getElementById('graphLoading').innerHTML = 
            '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: vis.js library not loaded</div>';
    }
});

function loadGraphData() {
    console.log('Loading graph data...');
    fetch('/api/graph-data/')
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Graph data received:', data);
            console.log('Nodes count:', data.nodes.length);
            console.log('Edges count:', data.edges.length);
            createGraph(data.nodes, data.edges);
            updateStats(data.nodes.length, data.edges.length);
        })
        .catch(error => {
            console.error('Error loading graph data:', error);
            document.getElementById('graphLoading').innerHTML = 
                '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error loading graph data</div>';
        });
}

function createGraph(nodesData, edgesData) {
    console.log('Creating graph with:', nodesData.length, 'nodes and', edgesData.length, 'edges');
    
    // Hide loading
    document.getElementById('graphLoading').style.display = 'none';
    document.getElementById('graphNetwork').style.display = 'block';
    
    // Create nodes
    nodes = new vis.DataSet(nodesData.map(node => ({
        id: node.id,
        label: node.label,
        title: node.title,
        author: node.author,
        size: node.size || 20,
        color: getNodeColor(node),
        font: { size: 12, face: 'Arial' },
        borderWidth: 2,
        shadow: true
    })));
    
    // Create edges
    edges = new vis.DataSet(edgesData.map(edge => ({
        from: edge.from,
        to: edge.to,
        arrows: 'to',
        width: 2,
        color: { color: '#666', opacity: 0.6 },
        smooth: { type: 'continuous' }
    })));
    
    // Create network
    const container = document.getElementById('graphNetwork');
    const data = { nodes, edges };
    const options = {
        nodes: {
            shape: 'circle',
            font: { size: 14, face: 'Arial' },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            width: 2,
            color: { color: '#666', opacity: 0.6 },
            smooth: { type: 'continuous' }
        },
        physics: {
            enabled: true,
            solver: 'forceAtlas2Based',
            forceAtlas2Based: {
                gravitationalConstant: -50,
                centralGravity: 0.01,
                springLength: 100,
                springConstant: 0.08,
                damping: 0.4,
                avoidOverlap: 0.5
            },
            stabilization: {
                enabled: true,
                iterations: 1000,
                updateInterval: 100
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200,
            hideEdgesOnDrag: true,
            zoomView: true,
            dragView: true
        }
    };
    
    network = new vis.Network(container, data, options);
    
    // Event listeners
    network.on('click', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            showPaperInfo(nodeId);
        } else {
            hidePaperInfo();
        }
    });
    
    network.on('stabilizationProgress', function(params) {
        // Update loading progress
        const progress = Math.round(params.iterations / params.total * 100);
        document.getElementById('graphLoading').innerHTML = 
            `<i class="fas fa-spinner"></i> Stabilizing graph... ${progress}%`;
    });
    
    network.on('stabilizationIterationsDone', function() {
        document.getElementById('graphLoading').style.display = 'none';
    });
}

function getNodeColor(node) {
    // Color nodes based on properties
    if (node.size > 25) return '#28a745'; // Highly cited
    if (node.size > 20) return '#ffc107'; // Many references
    return '#007bff'; // Regular papers
}

function showPaperInfo(nodeId) {
    const node = nodes.get(nodeId);
    if (!node) return;
    
    selectedPaperId = nodeId;
    
    document.getElementById('paperTitle').textContent = node.title;
    document.getElementById('paperAuthor').textContent = `Author: ${node.author}`;
    document.getElementById('paperYear').textContent = `Year: ${node.year || 'N/A'}`;
    document.getElementById('paperReferences').textContent = `References: ${getReferenceCount(nodeId)}`;
    document.getElementById('paperCitations').textContent = `Citations: ${getCitationCount(nodeId)}`;
    
    document.getElementById('viewPaperBtn').onclick = function() {
        window.location.href = `/paper/${nodeId}/`;
    };
    
    document.getElementById('paperInfo').style.display = 'block';
}

function hidePaperInfo() {
    document.getElementById('paperInfo').style.display = 'none';
    selectedPaperId = null;
}

function getReferenceCount(nodeId) {
    return edges.get().filter(edge => edge.from === nodeId).length;
}

function getCitationCount(nodeId) {
    return edges.get().filter(edge => edge.to === nodeId).length;
}

function updateStats(nodeCount, edgeCount) {
    document.getElementById('totalNodes').textContent = nodeCount;
    document.getElementById('totalEdges').textContent = edgeCount;
    
    // Calculate additional stats
    const avgRefs = edgeCount > 0 ? (edgeCount / nodeCount).toFixed(1) : 0;
    document.getElementById('avgReferences').textContent = avgRefs;
    
    // Estimate max depth (simplified)
    const maxDepth = Math.min(Math.ceil(Math.log2(nodeCount)), 5);
    document.getElementById('maxDepth').textContent = maxDepth;
}

// Graph control functions
function fitGraph() {
    if (network) network.fit();
}

function stabilizeGraph() {
    if (network) network.stabilize();
}

function resetGraph() {
    if (network) {
        network.fit();
        network.stabilize();
    }
}

function exportGraph() {
    if (!network) return;
    
    const data = {
        nodes: nodes.get(),
        edges: edges.get()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reference_graph.json';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
