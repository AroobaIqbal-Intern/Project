{% extends 'base.html' %}
{% load static %}

{% block title %}{{ paper.title }} - Paper Detail{% endblock %}

{% block extra_css %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
.paper-container {
    position: relative;
    height: 80vh;
    overflow: hidden;
}

.paper-viewer {
    width: 100%;
    height: 100%;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f9fa;
    position: relative;
}

.paper-content {
    padding: 2rem;
    height: 100%;
    overflow-y: auto;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    font-size: 14px;
}

.paper-content.zoomed {
    font-size: 18px;
    line-height: 1.8;
}

.chatbot-panel {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 350px;
    height: 500px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.chatbot-header {
    background: #007bff;
    color: white;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chatbot-toggle {
    position: fixed;
    right: 20px;
    top: 100px;
    z-index: 1001;
}

.chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
}

.chatbot-input {
    padding: 1rem;
    border-top: 1px solid #ddd;
    background: white;
}

.message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    max-width: 80%;
}

.message.user {
    background: #007bff;
    color: white;
    margin-left: auto;
}

.message.assistant {
    background: #e9ecef;
    color: #333;
}

.highlight {
    background: #ffd700;
    padding: 2px 4px;
    border-radius: 3px;
    margin: 0 2px;
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.highlight:hover {
    background-color: #FFA500;
    transform: scale(1.05);
}

.highlight.question {
    background: #ff6b6b;
    color: white;
}

.highlight.answer {
    background: #4ecdc4;
    color: white;
}

.zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
}

.zoom-btn {
    background: rgba(255,255,255,0.9);
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 2px;
    cursor: pointer;
    font-size: 18px;
}

.zoom-btn:hover {
    background: white;
}

.references-section {
    margin-top: 2rem;
    padding: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.reference-item {
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    margin-bottom: 1rem;
    transition: all 0.2s;
}

.reference-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.collapsed {
    display: none;
}

.source-content {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-top: 1rem;
}

.chunk-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.chunk-text {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
    color: #495057;
}

.chunk-phrases {
    border-top: 1px solid #e9ecef;
    padding-top: 0.5rem;
    margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Paper Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item active">{{ paper.title|truncatechars:50 }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h2 mb-2">{{ paper.title }}</h1>
                    <p class="text-muted mb-2">
                        <i class="fas fa-user"></i> {{ paper.author }}
                        {% if paper.year %} • <i class="fas fa-calendar"></i> {{ paper.year }}{% endif %}
                        {% if paper.journal %} • <i class="fas fa-book"></i> {{ paper.journal }}{% endif %}
                        {% if paper.reference_count %} • <i class="fas fa-link"></i> {{ paper.reference_count }} references{% endif %}
                        {% if paper.citation_count %} • <i class="fas fa-quote-left"></i> {{ paper.citation_count }} citations{% endif %}
                    </p>
                    {% if paper.abstract %}
                    <p class="lead">{{ paper.abstract }}</p>
                    {% endif %}
                </div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="toggleZoom()">
                        <i class="fas fa-search-plus"></i> Toggle Zoom
                    </button>
                            <button class="btn btn-outline-info" onclick="toggleChatbot()">
            <i class="fas fa-comments"></i> Toggle Chatbot
        </button>
        <button class="btn btn-outline-warning" onclick="clearHighlights()" id="clearHighlightsBtn" style="display: none;">
            <i class="fas fa-eraser"></i> Clear Highlights
        </button>
                    {% if paper.file %}
                        <a href="{{ paper.file.url }}" class="btn btn-outline-success" target="_blank">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% else %}
                        <span class="btn btn-outline-secondary disabled">
                            <i class="fas fa-info-circle"></i> No file available
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <div class="col-12">
            <div class="paper-container">
                <div class="paper-viewer">
                    <!-- Zoom Controls -->
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                    
                    <!-- Paper Content -->
                    <div class="paper-content" id="paperContent">
                        {% if paper.content_text and paper.content_text.strip %}
                            {{ paper.content_text|linebreaks }}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                                <h4 class="text-muted">Paper content not available</h4>
                                {% if paper.file %}
                                    <p class="text-muted">The paper content is being processed. Please try again later.</p>
                                    <div class="mt-3">
                                        <button class="btn btn-outline-primary" onclick="retryProcessing()">
                                            <i class="fas fa-sync-alt"></i> Retry Processing
                                        </button>
                                    </div>
                                {% else %}
                                    <p class="text-muted">This is a referenced paper without uploaded content.</p>
                                    <p class="text-muted">It was automatically created from a reference in another paper.</p>
                                    <div class="mt-3">
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-info-circle"></i> About Referenced Papers</h6>
                                            <p class="mb-2">This paper was discovered as a reference in another uploaded paper. To view its full content, you would need to:</p>
                                            <ul class="text-left">
                                                <li>Upload the actual PDF or document file</li>
                                                <li>Or find the paper through external sources</li>
                                            </ul>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary" onclick="uploadReferencedPaper()">
                                                    <i class="fas fa-upload"></i> Upload This Paper
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {% if cited_by %}
                                        <div class="alert alert-warning mt-3">
                                            <h6><i class="fas fa-link"></i> Referenced In</h6>
                                            <p class="mb-2">This paper is referenced in the following uploaded papers:</p>
                                            <ul class="text-left">
                                                {% for ref in cited_by %}
                                                <li>
                                                    <a href="{% url 'paper_detail' ref.source_paper.id %}" class="text-decoration-none">
                                                        {{ ref.source_paper.title|truncatechars:80 }}
                                                    </a>
                                                    <small class="text-muted">by {{ ref.source_paper.author }}</small>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- References Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="references-section">
                <h3 class="mb-4">
                    <i class="fas fa-link"></i> References 
                    <span class="badge bg-primary">{{ references.count }}</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="extractReferences()" title="Manually extract references">
                        <i class="fas fa-sync-alt"></i> Extract References
                    </button>
                </h3>
                
                {% if references %}
                    <div class="row">
                        {% for ref in references %}
                        <div class="col-md-6 mb-3">
                            <div class="reference-item">
                                <h6 class="mb-2">
                                    {% if ref.target_paper.id %}
                                        <a href="{% url 'paper_detail' ref.target_paper.id %}" class="text-decoration-none">
                                            {{ ref.target_paper.title|truncatechars:80 }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">{{ ref.target_paper.title|truncatechars:80 }}</span>
                                    {% endif %}
                                </h6>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-user"></i> {{ ref.target_paper.author }}
                                    {% if ref.target_paper.year %} • {{ ref.target_paper.year }}{% endif %}
                                </p>
                                {% if ref.reference_text %}
                                <small class="text-muted d-block mt-1">{{ ref.reference_text|truncatechars:150 }}</small>
                                {% endif %}
                                <div class="mt-2">
                                    <small class="text-info">
                                        <i class="fas fa-link"></i> 
                                        {% if ref.target_paper.file %}
                                            <span class="text-success">Has uploaded content</span>
                                        {% else %}
                                            <span class="text-warning">Reference only - no uploaded content</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">No references found for this paper.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Cited By Section -->
    {% if cited_by %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="references-section">
                <h3 class="mb-4">
                    <i class="fas fa-quote-left"></i> Cited By 
                    <span class="badge bg-success">{{ cited_by.count }}</span>
                </h3>
                
                <div class="row">
                    {% for citing_paper in cited_by %}
                    <div class="col-md-6 mb-3">
                        <div class="reference-item">
                            <h6 class="mb-2">
                                {% if citing_paper.source_paper.id %}
                                    <a href="{% url 'paper_detail' citing_paper.source_paper.id %}" class="text-decoration-none">
                                        {{ citing_paper.source_paper.title|truncatechars:80 }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">{{ citing_paper.source_paper.title|truncatechars:80 }}</span>
                                {% endif %}
                            </h6>
                            <p class="text-muted mb-2">
                                <i class="fas fa-user"></i> {{ citing_paper.source_paper.author }}
                                {% if citing_paper.source_paper.year %} • {{ citing_paper.source_paper.year }}{% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Chatbot Panel -->
<div class="chatbot-panel collapsed" id="chatbotPanel">
    <div class="chatbot-header">
        <h6 class="mb-0">
            <i class="fas fa-robot"></i> Paper Assistant
        </h6>
        <button type="button" class="btn-close btn-close-white" onclick="toggleChatbot()"></button>
    </div>
    
    <div class="chatbot-messages" id="chatbotMessages">
        <div class="message assistant">
            <strong>Paper Assistant:</strong> Hello! I can help you understand this paper. Ask me any questions about the content, methodology, findings, or references.
        </div>
    </div>
    
    <div class="chatbot-input">
        <div class="input-group">
            <input type="text" class="form-control" id="chatbotInput" 
                   placeholder="Ask a question about this paper..." 
                   onkeypress="handleChatbotKeyPress(event)">
            <button class="btn btn-primary" type="button" onclick="sendChatbotMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Chatbot Toggle Button -->
<button class="btn btn-primary chatbot-toggle collapsed" id="chatbotToggle" onclick="toggleChatbot()">
    <i class="fas fa-comments"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
let currentZoom = 1;
let chatbotVisible = false;

// Zoom functions
function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 3);
    applyZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 0.5);
    applyZoom();
}

function resetZoom() {
    currentZoom = 1;
    applyZoom();
}

function applyZoom() {
    const content = document.getElementById('paperContent');
    content.style.transform = `scale(${currentZoom})`;
    content.style.transformOrigin = 'top left';
}

function toggleZoom() {
    const content = document.getElementById('paperContent');
    if (content.classList.contains('zoomed')) {
        content.classList.remove('zoomed');
        currentZoom = 1;
    } else {
        content.classList.add('zoomed');
        currentZoom = 1.5;
    }
    applyZoom();
}

// Chatbot functions
function toggleChatbot() {
    const panel = document.getElementById('chatbotPanel');
    const toggle = document.getElementById('chatbotToggle');
    
    if (chatbotVisible) {
        panel.classList.add('collapsed');
        toggle.classList.remove('collapsed');
        chatbotVisible = false;
    } else {
        panel.classList.remove('collapsed');
        toggle.classList.add('collapsed');
        chatbotVisible = true;
        document.getElementById('chatbotInput').focus();
    }
}

function handleChatbotKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatbotMessage();
    }
}

function sendChatbotMessage() {
    const input = document.getElementById('chatbotInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addChatbotMessage(message, 'user');
    input.value = '';
    
    // Send to backend
    fetch(`/api/chatbot/papers/{{ paper.id }}/chat/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: message,
            session_id: 'session_' + Date.now()
        })
    })
    .then(response => {
        console.log('Chatbot response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Chatbot response data:', data);
        
        if (data.error) {
            addChatbotMessage(`Error: ${data.error}`, 'assistant');
            return;
        }
        
        if (data.assistant_message) {
            addChatbotMessage(data.assistant_message.content, 'assistant');
            
            // Show the source content used for the answer
            if (data.highlighting_data && data.highlighting_data.length > 0) {
                showSourceContent(data.highlighting_data);
            }
            
            // Highlight relevant content if available
            if (data.highlights_created) {
                if (data.highlighting_data) {
                    highlightRelevantContent(data.highlighting_data);
                } else if (data.assistant_message.relevant_chunks) {
                    highlightRelevantContent(data.assistant_message.relevant_chunks);
                }
            }
        } else {
            addChatbotMessage('Sorry, I received an unexpected response format.', 'assistant');
        }
    })
    .catch(error => {
        console.error('Chatbot error:', error);
        addChatbotMessage('Sorry, I encountered an error. Please try again. If the problem persists, check if the paper has been properly processed.', 'assistant');
    });
}

function addChatbotMessage(content, type) {
    const messages = document.getElementById('chatbotMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.innerHTML = `<strong>${type === 'user' ? 'You:' : 'Paper Assistant:'}</strong> ${content}`;
    
    messages.appendChild(messageDiv);
    messages.scrollTop = messages.scrollHeight;
}

function highlightRelevantContent(chunks) {
    console.log('Relevant chunks:', chunks);
    
    if (!chunks || chunks.length === 0) return;
    
    // Get the paper content element
    const paperContent = document.getElementById('paperContent');
    if (!paperContent) {
        console.error('Paper content element not found');
        return;
    }
    
    // Clear existing highlights
    const existingHighlights = paperContent.querySelectorAll('.highlight');
    existingHighlights.forEach(h => {
        const parent = h.parentNode;
        if (parent) {
            parent.replaceChild(document.createTextNode(h.textContent), h);
            parent.normalize(); // Merge adjacent text nodes
        }
    });
    
    // Get the text content for searching
    const originalText = paperContent.textContent || paperContent.innerText;
    let highlightedText = originalText;
    let highlightCount = 0;
    
    console.log('Original text length:', originalText.length);
    
    // Add new highlights
    chunks.forEach((chunk, index) => {
        let phrases = [];
        
        // Handle different data structures
        if (chunk.phrases && Array.isArray(chunk.phrases)) {
            // New format with pre-extracted phrases
            phrases = chunk.phrases;
        } else if (chunk.content) {
            // Old format - extract phrases from content
            phrases = extractKeyPhrases(chunk.content);
        }
        
        console.log(`Chunk ${index} phrases:`, phrases);
        
        phrases.forEach(phrase => {
            if (phrase.length > 20) { // Only highlight meaningful phrases
                // Try exact match first
                if (highlightedText.includes(phrase)) {
                    console.log('Exact match found:', phrase);
                    const highlightSpan = createHighlightSpan(phrase, chunk, index);
                    const regex = new RegExp(phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    highlightedText = highlightedText.replace(regex, highlightSpan);
                    highlightCount++;
                } else {
                    // Try fuzzy matching for better results
                    const fuzzyMatch = findFuzzyMatch(phrase, highlightedText);
                    if (fuzzyMatch) {
                        console.log('Fuzzy match found:', fuzzyMatch, 'for phrase:', phrase);
                        const highlightSpan = createHighlightSpan(fuzzyMatch, chunk, index);
                        const regex = new RegExp(fuzzyMatch.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                        highlightedText = highlightedText.replace(regex, highlightSpan);
                        highlightCount++;
                    } else {
                        // Try to find the most similar text segment
                        const similarMatch = findSimilarText(phrase, highlightedText);
                        if (similarMatch) {
                            console.log('Similar match found:', similarMatch, 'for phrase:', phrase);
                            const highlightSpan = createHighlightSpan(similarMatch, chunk, index);
                            const regex = new RegExp(similarMatch.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                            highlightedText = highlightedText.replace(regex, highlightSpan);
                            highlightCount++;
                        }
                    }
                }
            }
        });
    });
    
    // Update the content with highlights
    if (highlightedText !== originalText) {
        paperContent.innerHTML = highlightedText;
        
        // Add hover effects to highlights
        const highlights = paperContent.querySelectorAll('.highlight');
        highlights.forEach(highlight => {
            highlight.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#FFA500';
                this.style.transform = 'scale(1.05)';
            });
            
            highlight.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#FFD700';
                this.style.transform = 'scale(1)';
            });
            
            // Add click to scroll into view
            highlight.addEventListener('click', function() {
                this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                this.style.backgroundColor = '#FF6B6B';
                setTimeout(() => {
                    this.style.backgroundColor = '#FFD700';
                }, 1000);
            });
        });
        
        // Scroll to first highlight if any found
        if (highlights.length > 0) {
            setTimeout(() => {
                highlights[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }
        
        // Show clear highlights button
        document.getElementById('clearHighlightsBtn').style.display = 'inline-block';
        
        // Show notification
        showHighlightNotification(highlightCount);
    } else {
        console.log('No matching content found for highlighting');
        showHighlightNotification(0);
    }
}

function extractKeyPhrases(text) {
    // Extract meaningful phrases from text
    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 20);
    const phrases = [];
    
    sentences.forEach(sentence => {
        // Extract phrases of 3-8 words
        const words = sentence.trim().split(/\s+/);
        for (let i = 0; i <= words.length - 3; i++) {
            for (let j = 3; j <= Math.min(8, words.length - i); j++) {
                const phrase = words.slice(i, i + j).join(' ');
                if (phrase.length > 15 && phrase.length < 100) {
                    phrases.push(phrase);
                }
            }
        }
    });
    
    // Return unique phrases, sorted by length (longer phrases first)
    return [...new Set(phrases)].sort((a, b) => b.length - a.length).slice(0, 10);
}

function createHighlightSpan(phrase, chunk, index) {
    // Create a unique ID for the highlight span
    const highlightId = `highlight-${index}-${chunk.chunk_id || chunk.id || Date.now()}`;
    
    // Create the highlight span
    const highlightSpan = `<span class="highlight" id="${highlightId}" data-chunk="${chunk.chunk_id || chunk.id || index}" style="background-color: #FFD700; padding: 2px 4px; border-radius: 3px; margin: 0 2px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: all 0.3s ease;">${phrase}</span>`;
    
    return highlightSpan;
}

function findFuzzyMatch(phrase, text) {
    // Use a fuzzy matching library (e.g., levenshtein-distance)
    // This is a simplified example. In a real application, you'd use a proper library.
    const normalizedPhrase = phrase.toLowerCase();
    const normalizedText = text.toLowerCase();
    
    // Find the closest match using a simple substring search
    let bestMatch = null;
    let minDistance = Infinity;
    
    // Iterate through sentences to find the closest match
    const sentences = text.split(/[.!?]+/);
    for (const sentence of sentences) {
        if (sentence.length < 30) continue; // Skip very short sentences
        
        const sentenceLower = sentence.toLowerCase();
        const distance = levenshteinDistance(normalizedPhrase, sentenceLower);
        
        if (distance < minDistance) {
            minDistance = distance;
            bestMatch = sentence.trim();
        }
    }
    
    // Return the best match if the distance is below a threshold (e.g., 30% of phrase length)
    if (bestMatch && minDistance < phrase.length * 0.3) {
        return bestMatch;
    }
    return null;
}

function levenshteinDistance(s1, s2) {
    const len1 = s1.length;
    const len2 = s2.length;
    const matrix = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));

    for (let i = 0; i <= len1; i++) {
        matrix[i][0] = i;
    }
    for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
    }

    for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
            if (s1[i - 1] === s2[j - 1]) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j] + 1, // Deletion
                    matrix[i][j - 1] + 1, // Insertion
                    matrix[i - 1][j - 1] + 1 // Substitution
                );
            }
        }
    }
    return matrix[len1][len2];
}

function findSimilarText(phrase, text) {
    // Find text that is semantically similar to the phrase
    const normalizedPhrase = normalizeText(phrase);
    const normalizedText = normalizeText(text);
    
    // Look for text segments that contain key words from the phrase
    const phraseWords = normalizedPhrase.split(' ').filter(w => w.length > 3);
    
    if (phraseWords.length < 2) return null;
    
    // Find text segments that contain most of the key words
    const sentences = text.split(/[.!?]+/);
    let bestMatch = null;
    let bestScore = 0;
    
    for (const sentence of sentences) {
        if (sentence.length < 30) continue;
        
        const sentenceLower = sentence.toLowerCase();
        let score = 0;
        
        for (const word of phraseWords) {
            if (sentenceLower.includes(word.toLowerCase())) {
                score++;
            }
        }
        
        // Calculate similarity score
        const similarity = score / phraseWords.length;
        if (similarity > bestScore && similarity > 0.5) { // At least 50% word overlap
            bestScore = similarity;
            bestMatch = sentence.trim();
        }
    }
    
    return bestMatch;
}

function normalizeText(text) {
    // Basic text normalization (e.g., remove punctuation, convert to lowercase)
    return text.replace(/[.,!?]/g, '').toLowerCase();
}

function showSourceContent(highlightingData) {
    // Create or update source content display
    let sourceContentDiv = document.getElementById('sourceContent');
    if (!sourceContentDiv) {
        sourceContentDiv = document.createElement('div');
        sourceContentDiv.id = 'sourceContent';
        sourceContentDiv.className = 'source-content mt-3 p-3 bg-light border rounded';
        sourceContentDiv.innerHTML = '<h6><i class="fas fa-info-circle"></i> Source Content Used:</h6>';
        
        // Insert after chatbot messages
        const chatbotMessages = document.getElementById('chatbotMessages');
        chatbotMessages.appendChild(sourceContentDiv);
    }
    
    // Clear previous content
    const contentList = sourceContentDiv.querySelector('.content-list');
    if (contentList) {
        contentList.remove();
    }
    
    // Create content list
    const contentListDiv = document.createElement('div');
    contentListDiv.className = 'content-list mt-2';
    
    highlightingData.forEach((chunk, index) => {
        const chunkDiv = document.createElement('div');
        chunkDiv.className = 'chunk-item mb-2 p-2 bg-white border rounded';
        chunkDiv.innerHTML = `
            <small class="text-muted">Chunk ${index + 1}:</small>
            <div class="chunk-text mt-1">${chunk.content.substring(0, 200)}...</div>
            <div class="chunk-phrases mt-1">
                <small class="text-info">Highlighted phrases: ${chunk.phrases ? chunk.phrases.slice(0, 3).join(', ') : 'None'}</small>
            </div>
        `;
        contentListDiv.appendChild(chunkDiv);
    });
    
    sourceContentDiv.appendChild(contentListDiv);
}

function showHighlightNotification(highlightCount) {
    // Remove existing notification
    const existingNotification = document.querySelector('.highlight-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = 'highlight-notification alert alert-info alert-dismissible fade show';
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.maxWidth = '300px';
    
    if (highlightCount > 0) {
        notification.innerHTML = `
            <strong>Content Highlighted!</strong><br>
            ${highlightCount} relevant sections have been highlighted in the paper.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notification.className = 'highlight-notification alert alert-success alert-dismissible fade show';
    } else {
        notification.innerHTML = `
            <strong>No Matches Found</strong><br>
            No exact matches found in the paper content for highlighting.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notification.className = 'highlight-notification alert alert-warning alert-dismissible fade show';
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove notification after 8 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 8000);
}

function clearHighlights() {
    const paperContent = document.getElementById('paperContent');
    if (!paperContent) return;
    
    // Remove all highlights
    const highlights = paperContent.querySelectorAll('.highlight');
    highlights.forEach(h => {
        const parent = h.parentNode;
        if (parent) {
            parent.replaceChild(document.createTextNode(h.textContent), h);
            parent.normalize();
        }
    });
    
    // Hide clear highlights button
    document.getElementById('clearHighlightsBtn').style.display = 'none';
    
    // Show notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show';
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <strong>Highlights Cleared!</strong> All highlights have been removed from the paper.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function retryProcessing() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    button.disabled = true;
    
    fetch(`/api/papers/{{ paper.id }}/process-references/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Processing started! Please refresh the page in a few moments to see the updated content.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error starting processing. Please try again.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function extractReferences() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting...';
    button.disabled = true;
    
    console.log('Starting reference extraction for paper:', '{{ paper.id }}');
    
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    console.log('CSRF Token:', csrfToken);
    
    fetch(`/api/papers/{{ paper.id }}/process-references/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.message) {
            alert('Reference extraction completed! Please refresh the page to see the updated references.');
            // Optionally refresh the page automatically
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error during reference extraction:', error);
        alert(`Error during reference extraction: ${error.message}. Please check the console for details.`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function uploadReferencedPaper() {
    // Redirect to upload page with pre-filled paper information
    const paperTitle = '{{ paper.title|escapejs }}';
    const paperAuthor = '{{ paper.author|escapejs }}';
    const paperYear = '{{ paper.year }}';
    
    // Create a form to submit to upload page
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "upload_paper" %}';
    
    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    form.appendChild(csrfInput);
    
    // Add paper info as hidden fields
    const titleInput = document.createElement('input');
    titleInput.type = 'hidden';
    titleInput.name = 'title';
    titleInput.value = paperTitle;
    form.appendChild(titleInput);
    
    const authorInput = document.createElement('input');
    authorInput.type = 'hidden';
    authorInput.name = 'author';
    authorInput.value = paperAuthor;
    form.appendChild(authorInput);
    
    const yearInput = document.createElement('input');
    yearInput.type = 'hidden';
    yearInput.name = 'year';
    yearInput.value = paperYear;
    form.appendChild(yearInput);
    
    // Add file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = 'paper_file';
    fileInput.accept = '.pdf,.docx,.txt';
    fileInput.style.display = 'none';
    fileInput.required = true;
    form.appendChild(fileInput);
    
    // Add form to page and trigger file selection
    document.body.appendChild(form);
    
    // Show file selection dialog
    fileInput.click();
    
    // Handle file selection
    fileInput.onchange = function() {
        if (fileInput.files.length > 0) {
            // Submit form
            form.submit();
        } else {
            // Remove form if no file selected
            document.body.removeChild(form);
        }
    };
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set initial zoom
    applyZoom();
});
</script>
{% endblock %}

